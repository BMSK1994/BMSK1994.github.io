<!DOCTYPE html><html lang="[&quot;zh-cn&quot;,&quot;en&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>OpenRASP-SSRF漏洞 | BMSK</title><meta name="author" content="bmsk"><meta name="copyright" content="bmsk"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="OpenRASP-SSRF漏洞漏洞简介​	SSRF（Server-Side Request Forge，服务端伪造请求），漏洞原理为，服务端提供了从其他服务器应用获取数据的功能且没有对目标地址和传入命令进行过滤与限制造成的，如常见的从指定URL加载图片、文本资源或者获取指定页面的网页内容等。 ​	攻击者首先向可直接访问的Web站点发送攻击载荷，该攻击载荷的攻击对象为内部网络，然后，Web站点作为“">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenRASP-SSRF漏洞">
<meta property="og:url" content="https://bmsk1994.github.io/2022/12/22/OpenRASP-SSRF%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="BMSK">
<meta property="og:description" content="OpenRASP-SSRF漏洞漏洞简介​	SSRF（Server-Side Request Forge，服务端伪造请求），漏洞原理为，服务端提供了从其他服务器应用获取数据的功能且没有对目标地址和传入命令进行过滤与限制造成的，如常见的从指定URL加载图片、文本资源或者获取指定页面的网页内容等。 ​	攻击者首先向可直接访问的Web站点发送攻击载荷，该攻击载荷的攻击对象为内部网络，然后，Web站点作为“">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bmsk1994.github.io/img/ssrf.jpg">
<meta property="article:published_time" content="2022-12-22T15:40:35.000Z">
<meta property="article:modified_time" content="2022-12-22T15:52:23.287Z">
<meta property="article:author" content="bmsk">
<meta property="article:tag" content="OpenRASP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bmsk1994.github.io/img/ssrf.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://bmsk1994.github.io/2022/12/22/OpenRASP-SSRF%E6%BC%8F%E6%B4%9E/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'OpenRASP-SSRF漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-22 23:52:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/ssrf.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">BMSK</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">OpenRASP-SSRF漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-12-22T15:40:35.000Z" title="Created 2022-12-22 23:40:35">2022-12-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-12-22T15:52:23.287Z" title="Updated 2022-12-22 23:52:23">2022-12-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">5.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>22min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="OpenRASP-SSRF漏洞"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="OpenRASP-SSRF漏洞"><a href="#OpenRASP-SSRF漏洞" class="headerlink" title="OpenRASP-SSRF漏洞"></a>OpenRASP-SSRF漏洞</h1><h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>​	SSRF（Server-Side Request Forge，服务端伪造请求），漏洞原理为，服务端提供了从其他服务器应用获取数据的功能且没有对目标地址和传入命令进行过滤与限制造成的，如常见的从指定URL加载图片、文本资源或者获取指定页面的网页内容等。</p>
<p>​	攻击者首先向可直接访问的Web站点发送攻击载荷，该攻击载荷的攻击对象为内部网络，然后，Web站点作为“中间人”，将包含有恶意攻击请求的请求传递给内部网络，内部网络接受请求并处理后，将结果返回给Web站点。最后，Web站点将内部网络返回的结果传递给攻击者，以此达到攻击内部网络的目的。</p>
<p>​	利用SSRF漏洞能实现的事情有：扫描内网、向内网任意主机的任意端口发送恶意请求、攻击内网Web应用、读取文件以及拒绝服务攻击等。Java中的SSRF利用有局限性，一般利用http&#x2F;https协议来探测端口、暴力穷举等，还可以通过file协议读取&#x2F;下载任意文件。</p>
<blockquote>
<p>file协议：也叫本地文件传输协议，主要用于访问本地计算机中的文件，url格式为“file:&#x2F;&#x2F;&#x2F;C:&#x2F;Users&#x2F;bmsk&#x2F;Desktop&#x2F;017-xss.jsp”。</p>
<p>file协议只能在本地访问，file无法实现跨域，file协议对应有一个类似http的远程访问，就是ftp协议，即文件传输协议。本地搭建http服务器开放端口后他人也可以通过http访问到你电脑中的文件，但是file协议做不到。所以file协议三道杠没有host名。</p>
</blockquote>
<h2 id="业务代码"><a href="#业务代码" class="headerlink" title="业务代码"></a>业务代码</h2><p>​	启动一个http服务器作为攻击目标：python38 -m http.server –bind 127.0.0.1 8090。</p>
<h3 id="1-URLConnection实现"><a href="#1-URLConnection实现" class="headerlink" title="1.URLConnection实现"></a>1.URLConnection实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//URlConnection是一个抽象类，有两个直接子类，分别是HttpURLConnection和JarURLConnection。</span></span><br><span class="line"><span class="comment">//默认情况下，URLConnection的传参没有有效控制时会引起SSRF漏洞。</span></span><br><span class="line"><span class="comment">//下面代码中，如果将urlConnection变量，强制转型为HttpURLConnection，则无法利用file协议的SSRF漏洞。即代码凡是带http都只支持http、https协议；</span></span><br><span class="line">	<span class="type">HttpURLConnection</span> <span class="variable">httpUrl</span> <span class="operator">=</span> (HttpURLConnection)urlConnection;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="meta">@RequestMapping(&quot;ssrf&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ssrf</span><span class="params">(String url, HttpServletResponse response)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">        <span class="type">URLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> u.openConnection();</span><br><span class="line">        <span class="comment">//HttpURLConnection httpUrl = (HttpURLConnection)urlConnection;直接替换下面urlConnection为httpUrl。</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(urlConnection.getInputStream(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">html</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        String htmlContent;</span><br><span class="line">        <span class="keyword">while</span> ((htmlContent = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            html.append(htmlContent);</span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        os.write(html.toString().getBytes());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//payload</span></span><br><span class="line">http:<span class="comment">//127.0.0.1:8083/ssrf?url=http://127.0.0.1:8090/1.txt</span></span><br><span class="line">http:<span class="comment">//127.0.0.1:8083/ssrf?url=file:///D:/TargetDir/1.txt</span></span><br></pre></td></tr></table></figure>

<h3 id="2-HttpClient实现"><a href="#2-HttpClient实现" class="headerlink" title="2.HttpClient实现"></a>2.HttpClient实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//引入依赖</span></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;httpclient&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">4.5</span><span class="number">.14</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//HttpClient提供了支持HTTP协议的客户端编程工具包，但显然这种写法不支持file协议</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;httpClient&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ssrfClient</span><span class="params">(String url,HttpServletResponse response)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line">        <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">        <span class="type">HttpResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.execute(httpGet);</span><br><span class="line">        <span class="comment">// 读取服务器响应数据</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(res.getEntity().getContent()));</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">resultBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        String temp=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((temp = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            resultBuffer.append(temp);</span><br><span class="line">        &#125;</span><br><span class="line">        br.close();</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        os.write(resultBuffer.toString().getBytes());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//payload</span></span><br><span class="line">http:<span class="comment">//127.0.0.1:8083/httpClient?url=http://127.0.0.1:8090/1.txt</span></span><br></pre></td></tr></table></figure>

<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>​	SSRF漏洞审计，通常可以从一些http请求函数入手。修复方式考虑以下几种，总结为增加权限、统一错误信息、限制域名IP端口协议等内容、设置访问白名单：</p>
<ul>
<li>增加访问权限。</li>
<li>限制请求的端口为http常用端口，比如80、443、8080、8090等。</li>
<li>同意错误信息，避免根据错误信息远端服务器的端口状态。</li>
<li>根据业务需求，判定所需的域名是否是常用的几个，若是，则将这几个特定域名加入白名单，并拒绝白名单域名之外的请求。</li>
<li>禁用不需要的协议，仅仅允许http和https请求。</li>
<li>根据请求来源，判定请求地址是否是固定请求来源，若是，则将这几个特定域名&#x2F;IP添加到白名单，并拒绝白名单域名&#x2F;IP之外的请求。</li>
<li>若业务需求和请求来源并不固定，则可编写函数，检测特定域名、判断是否是内网IP、判断是否为http&#x2F;https协议等。</li>
</ul>
<h2 id="OpenRASP检测流程"><a href="#OpenRASP检测流程" class="headerlink" title="OpenRASP检测流程"></a>OpenRASP检测流程</h2><p>远程调试：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -javaagent:D:\javaProject\testRASP\target\rasp\rasp.jar -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=9193 -jar rasp-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<p>以agent方式启动springboot项目：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -javaagent:D:\javaProject\testRASP\target\rasp\rasp.jar -jar rasp-0.0.1-SNAPSHOT.jar(springboot项目.jar)</span><br></pre></td></tr></table></figure>

<h3 id="HttpClientHook"><a href="#HttpClientHook" class="headerlink" title="HttpClientHook"></a>HttpClientHook</h3><p>应用类：org&#x2F;apache&#x2F;http&#x2F;impl&#x2F;client&#x2F;CloseableHttpClient、org&#x2F;apache&#x2F;http&#x2F;impl&#x2F;client&#x2F;AutoRetryHttpClient、org&#x2F;apache&#x2F;http&#x2F;impl&#x2F;client&#x2F;DecompressingHttpClient、org&#x2F;apache&#x2F;http&#x2F;impl&#x2F;client&#x2F;AbstractHttpClient</p>
<p>hook类：HttpClientHook</p>
<p>​	hookMethod考虑到http client的不同版本，从接口角度进行匹配，只有实现了HttpClient接口（感觉isClassMatched已经做到），才会对该拦截类插桩。</p>
<p>​	进一步考虑到client.execute方法的多态性，根据方法签名（即形参+返回值）的不同调用检测代码checkHttpHost或checkHttpUri，这两个方法逻辑一致，都是从应用类方法execute的形参HttpUriRequest或形参HttpHost提取出url、hostname、function（即参数，requestmapping）、port、ip信息，传递给HookHandler.doCheck进入检测逻辑。SSRF漏洞的检测，仍交给V8AttackChecker去做。</p>
<p>​	上述检测代码checkHttpHost或checkHttpUri被插桩在client.execute方法执行前，而exitCheck被插桩在client.execute方法执行执行后，被传入的参数是execute的第一个形参和返回值。在我的测试中，checkHttpHost就已经阻断对“ <a target="_blank" rel="noopener" href="http://127.0.0.1:8090/1.txt">http://127.0.0.1:8090/1.txt</a> ”的访问，进入exitCheck方法时response为null，从而跳过该检测。exitCheck方法，从线程私有变量uriCache提取出重定向url，将本次请求url和重定向url同时放入params，并交给HookHandler.doCheck进入V8检测。</p>
<p>​	（这部分比较迷，什么情况下会出现重定向还是没看懂…业务代码本身不就是对新url的访问？）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//位于HttpClientHook的hookMethod方法</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookMethod</span><span class="params">(CtClass ctClass)</span> <span class="keyword">throws</span> IOException, CannotCompileException, NotFoundException &#123;</span><br><span class="line">    CtClass[] interfaces = ctClass.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (interfaces != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (CtClass inter : interfaces) &#123;</span><br><span class="line">            <span class="comment">// hook的应用类需要实现HttpClient接口，感觉和isClassMatched方法有重复</span></span><br><span class="line">            <span class="keyword">if</span> (inter.getName().equals(<span class="string">&quot;org.apache.http.client.HttpClient&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">//穷举client类多态的execute方法</span></span><br><span class="line">                LinkedList&lt;CtBehavior&gt; methods =</span><br><span class="line">                    getMethod(ctClass, <span class="string">&quot;execute&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                <span class="comment">//$1应该表示第一个形参，$_表示方法的返回值</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">afterSrc</span> <span class="operator">=</span> getInvokeStaticSrc(HttpClientHook.class, <span class="string">&quot;exitCheck&quot;</span>,</span><br><span class="line">                                                     <span class="string">&quot;$1,$_&quot;</span>, Object.class, Object.class);</span><br><span class="line">                <span class="comment">//根据多态的execute方法的第一个形参，在excute方法执行前插入checkHttpUri或者checkHttpHost</span></span><br><span class="line">                <span class="keyword">for</span> (CtBehavior method : methods) &#123;</span><br><span class="line">                    <span class="comment">//方法标签：（新参）返回值，其中类名前的L代表对象类型，[代表数组</span></span><br><span class="line">                    <span class="keyword">if</span> (method.getSignature().startsWith(<span class="string">&quot;(Lorg/apache/http/client/methods/HttpUriRequest&quot;</span>)) &#123;</span><br><span class="line">                        <span class="comment">//可以看到，javassist通过$1获取应用类方法的形参</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">src</span> <span class="operator">=</span> getInvokeStaticSrc(HttpClientHook.class,</span><br><span class="line">                                                        <span class="string">&quot;checkHttpUri&quot;</span>, <span class="string">&quot;$1&quot;</span>, Object.class);</span><br><span class="line">                        insertBefore(method, src);</span><br><span class="line">                        insertAfter(method, afterSrc, <span class="literal">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getSignature().startsWith(<span class="string">&quot;(Lorg/apache/http/HttpHost&quot;</span>)) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">src</span> <span class="operator">=</span> getInvokeStaticSrc(HttpClientHook.class,</span><br><span class="line">                                                        <span class="string">&quot;checkHttpHost&quot;</span>, <span class="string">&quot;$1&quot;</span>, Object.class);</span><br><span class="line">                        insertBefore(method, src);</span><br><span class="line">                        insertAfter(method, afterSrc, <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//checkHttpUri或者checkHttpHost方法</span></span><br><span class="line">isChecking.set(<span class="literal">true</span>);  <span class="comment">//isChecking是ThreadLocal变量</span></span><br><span class="line"><span class="comment">//最终在getSsrfParam获取params</span></span><br><span class="line">HashMap&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">params.put(<span class="string">&quot;url&quot;</span>, url);</span><br><span class="line">params.put(<span class="string">&quot;hostname&quot;</span>, hostname);</span><br><span class="line">params.put(<span class="string">&quot;function&quot;</span>, function);</span><br><span class="line">params.put(<span class="string">&quot;port&quot;</span>, port);</span><br><span class="line">LinkedList&lt;String&gt; ip = getIpList(hostname);</span><br><span class="line">Collections.sort(ip);</span><br><span class="line">params.put(<span class="string">&quot;ip&quot;</span>, ip);</span><br><span class="line">HookHandler.doCheck(CheckParameter.Type.SSRF, params);</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//exitCheck方法</span></span><br><span class="line"><span class="keyword">if</span> (isChecking.get() &amp;&amp; response != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">URI</span> <span class="variable">redirectUri</span> <span class="operator">=</span> HttpClientRedirectHook.uriCache.get();</span><br><span class="line">    <span class="keyword">if</span> (redirectUri != <span class="literal">null</span>) &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; params = getSsrfParam(uriValue);</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="literal">null</span>) &#123;</span><br><span class="line">            HashMap&lt;String, Object&gt; redirectParams = getSsrfParamFromURI(redirectUri);</span><br><span class="line">            <span class="keyword">if</span> (redirectParams != <span class="literal">null</span>) &#123;</span><br><span class="line">                AbstractRedirectHook.checkHttpClientRedirect(params, redirectParams, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">HookHandler.doCheck(CheckParameter.Type.SSRF_REDIRECT, params);</span><br></pre></td></tr></table></figure>

<h3 id="URLConnectionHook"><a href="#URLConnectionHook" class="headerlink" title="URLConnectionHook"></a>URLConnectionHook</h3><p>应用类：sun&#x2F;net&#x2F;www&#x2F;protocol&#x2F;http&#x2F;HttpURLConnection、weblogic&#x2F;net&#x2F;http&#x2F;HttpURLConnection</p>
<p>hook类：URLConnectionHook</p>
<p>​	 检测代码checkHttpConnection和onExit，分别会被插桩在urlConnection.getInputStream执行前后。checkHttpConnection方法逻辑同上，将url、hostname、function（即参数，requestmapping）、port、ip信息放入params，交给V8检测，并设置isChecking和originCache两个线程缓存。</p>
<p>​	onExit方法，会从URLConnectionRedirectHook.urlCache缓存中取出重定向url，V8检测本次请求url和重定向url相关信息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//URLConnectionHook类的hookMethod方法</span></span><br><span class="line"><span class="comment">//这里参数$0应该表示this，即该URLConnection实例</span></span><br><span class="line"><span class="type">String</span> <span class="variable">src</span> <span class="operator">=</span> getInvokeStaticSrc(URLConnectionHook.class, <span class="string">&quot;checkHttpConnection&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;$0&quot;</span>, URLConnection.class);</span><br><span class="line">insertBefore(ctClass, <span class="string">&quot;getInputStream&quot;</span>, <span class="string">&quot;()Ljava/io/InputStream;&quot;</span>, src);</span><br><span class="line">src = getInvokeStaticSrc(URLConnectionHook.class, <span class="string">&quot;onExit&quot;</span>, <span class="string">&quot;$0&quot;</span>, Object.class);</span><br><span class="line">insertAfter(ctClass, <span class="string">&quot;getInputStream&quot;</span>, <span class="string">&quot;()Ljava/io/InputStream;&quot;</span>, src, <span class="literal">true</span>);</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//checkHttpConnection方法</span></span><br><span class="line">isChecking.set(<span class="literal">true</span>);</span><br><span class="line"><span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> urlConnection.getURL();</span><br><span class="line">HashMap&lt;String, Object&gt; param = getSsrfParamWithURL(url);	<span class="comment">//获取的所有信息同HttpClientHook类</span></span><br><span class="line">HookHandler.doCheck(CheckParameter.Type.SSRF, params);</span><br><span class="line">originCache.set(param);</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//onExit方法</span></span><br><span class="line"><span class="keyword">if</span> (isChecking.get() &amp;&amp; !isExit.get() &amp;&amp; URLConnectionRedirectHook.urlCache.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 以下会继续调用 getinpustream isExit 避免死循环</span></span><br><span class="line">    isExit.set(<span class="literal">true</span>);</span><br><span class="line">    HashMap&lt;String, Object&gt; cache = originCache.get();</span><br><span class="line">    HashMap&lt;String, Object&gt; redirectCache = getSsrfParamWithURL(URLConnectionRedirectHook.urlCache.get());</span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="literal">null</span> &amp;&amp; redirectCache != <span class="literal">null</span>) &#123;</span><br><span class="line">        AbstractRedirectHook.checkRedirect(cache, redirectCache,</span><br><span class="line">                                           ((HttpURLConnection) urlConnection).getResponseMessage(), ((HttpURLConnection) urlConnection).getResponseCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">HookHandler.doCheck(CheckParameter.Type.SSRF_REDIRECT, params);</span><br></pre></td></tr></table></figure>

<h3 id="HttpClientRedirectHook（302重定向SSRF）"><a href="#HttpClientRedirectHook（302重定向SSRF）" class="headerlink" title="HttpClientRedirectHook（302重定向SSRF）"></a>HttpClientRedirectHook（302重定向SSRF）</h3><p>应用类：org&#x2F;apache&#x2F;http&#x2F;impl&#x2F;client&#x2F;DefaultRedirectStrategy、org&#x2F;apache&#x2F;http&#x2F;impl&#x2F;client&#x2F;DefaultRedirectHandler</p>
<p>hook类：HttpClientRedirectHook</p>
<p>​	在client.execute方法返回前，OpenRASP将检测代码exitCheck插桩到该位置执行，exitCheck方法会先从HttpClientRedirectHook的线程变量uriCache拿到重定向url，再将本次请求url和重定向url交给V8。在当时的测试用例中，response为null导致没有进入这部分检测逻辑，其实这是在检测另一种攻击方式，302重定向SSRF，这里我们对它展开分析。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//模型</span></span><br><span class="line">服务端接口：http:<span class="comment">//192.168.1.3:8083/httpClient</span></span><br><span class="line">重定向服务：python38 302redirect.py <span class="number">8091</span> http:<span class="comment">//127.0.0.1:8090/1.txt </span></span><br><span class="line">攻击目标：python38 -m http.server --bind <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">8090</span></span><br><span class="line">payload：http:<span class="comment">//192.168.1.3:8083/httpClient?url=http://mtw.so/5Ct624</span></span><br><span class="line">短链接转换器：相当于存储了key-value：http:<span class="comment">//mtw.so/5Ct624 - http://192.168.1.3:8091</span></span><br></pre></td></tr></table></figure>

<h4 id="302重定向SSRF"><a href="#302重定向SSRF" class="headerlink" title="302重定向SSRF"></a>302重定向SSRF</h4><p>​	302重定向是服务端发起的，浏览器使用者无法控制。很常见的功能是，用户在浏览器登录界面输入用户名和密码正确后，服务端将页面重定向到登陆成功页面。以OpenRASP为例，用户请求 <a target="_blank" rel="noopener" href="http://127.0.0.1:8083/httpClient?url=127.0.0.1:8090/1.txt">http://127.0.0.1:8083/httpClient?url=127.0.0.1:8090/1.txt</a> 时，被SSRF检测阻断，这时候服务端返回的response状态码是302，Location字段就是小恐龙页面地址，浏览器会自动解析出该地址，跳转到小恐龙页面。</p>
<p>​	那302重定向如何应用在SSRF呢？</p>
<p>​	因为此时服务端充当了上述模型中浏览器的角色。在HttpClient业务代码中，假设用户请求为 <a target="_blank" rel="noopener" href="http://192.168.1.3:8083/httpClient?url=http://mtw.so/5Ct624">http://192.168.1.3:8083/httpClient?url=http://mtw.so/5Ct624</a> ，其中 <a target="_blank" rel="noopener" href="http://mtw.so/5Ct624">http://mtw.so/5Ct624</a> 充当302跳转服务。该跳转服务的功能很简单，返回的response是302，Location字段为“ <a target="_blank" rel="noopener" href="http://127.0.0.1:8090/1.txt">http://127.0.0.1:8090/1.txt</a> ”。</p>
<p>​	这样HttpClient业务代码中，url为 <a target="_blank" rel="noopener" href="http://mtw.so/5Ct624">http://mtw.so/5Ct624</a> 不是内网地址，不会触发SSRF检测，服务端client.execute(url)后获得重定向地址为“ <a target="_blank" rel="noopener" href="http://127.0.0.1:8090/1.txt">http://127.0.0.1:8090/1.txt</a> ”，client.execute(url)内部的重定向机制会自动访问该重定向地址，从而绕过HttpClient业务代码中对传参url的过滤。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)-<span class="number">1</span> != <span class="number">2</span>:</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Usage: &#123;&#125; &lt;port_number&gt; &lt;url&gt;&quot;</span>.<span class="built_in">format</span>(sys.argv[<span class="number">0</span>]))</span><br><span class="line">  sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Redirect</span>(<span class="title class_ inherited__">BaseHTTPRequestHandler</span>):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">    self.send_response(<span class="number">302</span>)</span><br><span class="line">    self.send_header(<span class="string">&#x27;Location&#x27;</span>, sys.argv[<span class="number">2</span>])</span><br><span class="line">    self.end_headers()</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">send_error</span>(<span class="params">self, code, message=<span class="literal">None</span></span>):</span><br><span class="line">    self.send_response(<span class="number">302</span>)</span><br><span class="line">    self.send_header(<span class="string">&#x27;Location&#x27;</span>, sys.argv[<span class="number">2</span>])</span><br><span class="line">    self.end_headers()</span><br><span class="line"></span><br><span class="line">HTTPServer((<span class="string">&quot;&quot;</span>, <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])), Redirect).serve_forever()</span><br><span class="line"></span><br><span class="line"><span class="comment"># python38 302redirect.py 8091 http://127.0.0.1:8090/1.txt</span></span><br><span class="line"><span class="comment"># 在本机8091开启重定向服务，对该服务的请求，返回response为302，response头Location字段指向http://127.0.0.1:8090/1.txt</span></span><br></pre></td></tr></table></figure>

<h4 id="OpenRASP检测重定向"><a href="#OpenRASP检测重定向" class="headerlink" title="OpenRASP检测重定向"></a>OpenRASP检测重定向</h4><p>​	OpenRASP对“302重定向SSRF”的检测点，就在client.execute(url)的重定向机制。远程调试上述示例时，观察调用栈如下图，client.execute(url)发现是302重定向时，在重定向逻辑中执行getLocationURI方法，获取重定向地址。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">cacheHttpRedirect:<span class="number">54</span>, HttpClientRedirectHook (com.baidu.openrasp.hook.ssrf.redirect)</span><br><span class="line">getLocationURI:<span class="number">197</span>, DefaultRedirectStrategy (org.apache.http.impl.client)</span><br><span class="line">getRedirect:<span class="number">223</span>, DefaultRedirectStrategy (org.apache.http.impl.client)</span><br><span class="line">execute:<span class="number">126</span>, RedirectExec (org.apache.http.impl.execchain)</span><br><span class="line">doExecute:<span class="number">185</span>, InternalHttpClient (org.apache.http.impl.client)</span><br><span class="line">execute:<span class="number">83</span>, CloseableHttpClient (org.apache.http.impl.client)</span><br><span class="line">execute:<span class="number">108</span>, CloseableHttpClient (org.apache.http.impl.client)</span><br><span class="line">execute:<span class="number">56</span>, CloseableHttpClient (org.apache.http.impl.client)</span><br><span class="line">ssrfClient:<span class="number">49</span>, SSRFController (com.bmsk.rasp.controller)</span><br></pre></td></tr></table></figure>

<p>​	OpenRASP中的hook类HttpClientRedirectHook，将检测代码cacheHttpRedirect插入getLocationURI方法返回前，检测逻辑是将getLocationURI的返回值（即重定向地址）缓存在线程变量uriCache。这样逻辑回到client.execute(url)时，该方法返回前会调用hook类HttpClientHook的exitCheck方法，该方法会对本次请求url和重定向url进行检测，从而阻断SSRF。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//HttpClientRedirectHook类的hookMethod方法</span></span><br><span class="line"><span class="type">String</span> <span class="variable">src</span> <span class="operator">=</span> getInvokeStaticSrc(HttpClientRedirectHook.class, <span class="string">&quot;cacheHttpRedirect&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;$_&quot;</span>, Object.class);</span><br><span class="line">insertAfter(ctClass, <span class="string">&quot;getLocationURI&quot;</span>, <span class="literal">null</span>, src);</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//cacheHttpRedirect方法</span></span><br><span class="line"><span class="keyword">if</span> (uri <span class="keyword">instanceof</span> URI) &#123;</span><br><span class="line">    uriCache.set((URI) uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	这样，HttpClientRedirectHook实质上，只是在client.execute(url)执行过程中，缓存了重定向url。HttpClientHook则在client.execute(url)执行前对url检测，检测目标是CheckParameter.Type.SSRF；在client.execute(url)执行返回前，再对本次请求url和重定向url进行检测，检测目标是CheckParameter.Type.SSRF_REDIRECT，形成了逻辑闭环。</p>
<p>​	在调试过程中，由于我使用短地址 <a target="_blank" rel="noopener" href="http://mtw.so/5Ct624">http://mtw.so/5Ct624</a> ，观察到HttpClient重复了两次302重定向。当然这不重要。简单提一下，短地址服务的原理还是302重定向，它相当于存储了key-value键值对，key为 <a target="_blank" rel="noopener" href="http://mtw.so/5Ct624">http://mtw.so/5Ct624</a> ，value为 <a target="_blank" rel="noopener" href="http://192.168.1.3:8091/">http://192.168.1.3:8091</a> ，当用户请求前者时，会重定向到后者。使用短地址，是因为我没有公网IP，为了观察OpenRASP的SSRF_REDIRECT检测，不至于被OpenRASP的SSRF检测直接通过内网IP阻断掉。</p>
<p>​	调试过程中的另一点认识，burpsuite抓不到127的包，能抓到192的包，说明其工作在wlan网卡，而不是本地环回网卡。</p>
<p>​	服务端防御“302重定向SSRF”的方式很简单，就是限制不能自动跳转：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">httpGet.setConfig(RequestConfig.custom().setRedirectsEnabled(<span class="literal">false</span>).build());</span><br></pre></td></tr></table></figure>

<h3 id="URLConnectionRedirectHook（302重定向SSRF）"><a href="#URLConnectionRedirectHook（302重定向SSRF）" class="headerlink" title="URLConnectionRedirectHook（302重定向SSRF）"></a>URLConnectionRedirectHook（302重定向SSRF）</h3><p>应用类：sun&#x2F;net&#x2F;www&#x2F;protocol&#x2F;http&#x2F;HttpURLConnection、weblogic&#x2F;net&#x2F;http&#x2F;HttpURLConnection</p>
<p>hook类：URLConnectionRedirectHook</p>
<p>​	URLConnectionRedirectHook检测逻辑和HttpClientRedirectHook一致，它将监测点插入urlConnection.getInputStream()的重定向机制。重定向机制执行到urlConnection.followRedirect()方法时，会调用检测代码cacheHttpRedirect，在线程变量urlCache中缓存重定向url，配合后续hook类URLConnectionHook的onExit方法，对本次请求url和重定向url进行检测。</p>
<p>​	从调用栈信息也可看到，不管是client.execute(url)，还是urlConnection.getInputStream()，重定向都是在其内部完成，OpenRASP基本也插桩在内部能获取重定向url的位置。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//payload：http://192.168.1.3:8083/ssrf?url=http://mtw.so/5v1FWr</span></span><br><span class="line">cacheHttpRedirect:<span class="number">39</span>, URLConnectionRedirectHook (com.baidu.openrasp.hook.ssrf.redirect)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect) [<span class="number">2</span>]</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">498</span>, Method (java.lang.reflect)</span><br><span class="line">followRedirect:<span class="number">2647</span>, HttpURLConnection (sun.net.www.protocol.http)</span><br><span class="line">getInputStream0:<span class="number">1830</span>, HttpURLConnection (sun.net.www.protocol.http)</span><br><span class="line">getInputStream:<span class="number">1498</span>, HttpURLConnection (sun.net.www.protocol.http)</span><br><span class="line">ssrf:<span class="number">27</span>, SSRFController (com.bmsk.rasp.controller)</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//URLConnectionRedirectHook类的hookMethod方法</span></span><br><span class="line"><span class="comment">//表示将followRedirect的this（urlConnection）、($w)$_不懂啥意思？传入cacheHttpRedirect</span></span><br><span class="line"><span class="type">String</span> <span class="variable">src</span> <span class="operator">=</span> getInvokeStaticSrc(URLConnectionRedirectHook.class, <span class="string">&quot;cacheHttpRedirect&quot;</span>,</span><br><span class="line"><span class="string">&quot;$0,($w)$_&quot;</span>, Object.class, Object.class);</span><br><span class="line"><span class="comment">//表示followRedirect是无参数，boolean返回值的方法</span></span><br><span class="line">insertAfter(ctClass, <span class="string">&quot;followRedirect&quot;</span>, <span class="string">&quot;()Z&quot;</span>, src, <span class="literal">false</span>);</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//cacheHttpRedirect方法</span></span><br><span class="line"><span class="keyword">if</span> ((Boolean) isRedirect) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        urlCache.set((URL) Reflection.invokeMethod(connection, <span class="string">&quot;getURL&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	禁止自动302重定向：conn.setInstanceFollowRedirects(false);</p>
<h4 id="JVM中原语类型签名"><a href="#JVM中原语类型签名" class="headerlink" title="JVM中原语类型签名"></a>JVM中原语类型签名</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Character     Type          Interpretation</span><br><span class="line">------------------------------------------</span><br><span class="line">B             <span class="type">byte</span>          signed <span class="type">byte</span>			</span><br><span class="line">C             <span class="type">char</span>          Unicode character</span><br><span class="line">D             <span class="type">double</span>        <span class="type">double</span>-precision floating-point value</span><br><span class="line">F             <span class="type">float</span>         single-precision floating-point value</span><br><span class="line">I             <span class="type">int</span>           integer</span><br><span class="line">J             <span class="type">long</span>          <span class="type">long</span> integer</span><br><span class="line">L&lt;classname&gt;; reference     an instance of class    <span class="comment">//引用类</span></span><br><span class="line">S             <span class="type">short</span>         signed <span class="type">short</span></span><br><span class="line">Z             <span class="type">boolean</span>       <span class="literal">true</span> or <span class="literal">false</span></span><br><span class="line">[             reference     one array dimension		<span class="comment">//数组</span></span><br></pre></td></tr></table></figure>

<p>​	疑问：如何将jar放入另一个项目源码中调试，比如IDEA打开OpenRASP项目源码，配置远程调试，此时还希望同时调试SpringBoot项目的源码，是将springboot项目.jar放入OpenRASP项目吗？没有找到合适的方法。是否可以学导入OpenRASP-v8那样，将springboot项目.jar放到mvn路径里。</p>
<h2 id="Java中SSRF的限制"><a href="#Java中SSRF的限制" class="headerlink" title="Java中SSRF的限制"></a>Java中SSRF的限制</h2><p>​	Java中SSRF仅支持 sun.net.<a target="_blank" rel="noopener" href="http://www.protocol/">www.protocol</a> 下的所有协议：http、https、file、ftp、mailto、jar和netdoc协议，可以通过file协议或netdoc协议列出目录，读取敏感文件，无回显时可通过ftp协议进行带外读取，可以通过http协议探测端口是否启用，但是，不能通过gopher协议拓展供给面，因为不支持该协议。</p>
<p>​	此外，在“302重定向SSRF”攻击中，要求传入的url协议必须和重定向的url协议一致，重定向url协议也受上述限制。</p>
<h2 id="SSRF检测算法"><a href="#SSRF检测算法" class="headerlink" title="SSRF检测算法"></a>SSRF检测算法</h2><p>1.控制变量</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SSRF - 来自用户输入，且为内网地址就拦截</span></span><br><span class="line"><span class="attr">ssrf_userinput</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>:   <span class="string">&#x27;算法1 - 用户输入匹配算法（支持 rebind 检测）&#x27;</span>,</span><br><span class="line">    <span class="attr">action</span>: <span class="string">&#x27;block&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// SSRF - 是否允许访问 aws metadata</span></span><br><span class="line"><span class="attr">ssrf_aws</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>:   <span class="string">&#x27;算法2 - 拦截 AWS/Aliyun/GCP metadata 访问&#x27;</span>,</span><br><span class="line">    <span class="attr">action</span>: <span class="string">&#x27;block&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// SSRF - 是否允许访问 dnslog 地址</span></span><br><span class="line"><span class="attr">ssrf_common</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>:    <span class="string">&#x27;算法3 - 拦截常见 dnslog 地址&#x27;</span>,</span><br><span class="line">    <span class="attr">action</span>:  <span class="string">&#x27;block&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// SSRF - 是否允许访问混淆后的IP地址</span></span><br><span class="line"><span class="attr">ssrf_obfuscate</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>:   <span class="string">&#x27;算法4 - 拦截混淆地址&#x27;</span>,</span><br><span class="line">    <span class="attr">action</span>: <span class="string">&#x27;ignore&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// SSRF - 禁止使用 curl 读取 file:///etc/passwd、php://filter/XXXX 这样的内容</span></span><br><span class="line"><span class="attr">ssrf_protocol</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>:      <span class="string">&#x27;算法5 - 拦截 php:// 等异常协议&#x27;</span>,</span><br><span class="line">    <span class="attr">action</span>:    <span class="string">&#x27;block&#x27;</span>,</span><br><span class="line">    <span class="attr">protocols</span>: [</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;gopher&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// python specific</span></span><br><span class="line">        <span class="string">&#x27;local_file&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;local-file&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// java specific</span></span><br><span class="line">        <span class="string">&#x27;jar&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;netdoc&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// php specific</span></span><br><span class="line">        <span class="string">&#x27;dict&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;phar&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;compress.zlib&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;compress.bzip2&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>2.匹配规则和返回内容</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">check_internal_ip</span>(<span class="params">ip, origin_ip</span>) &#123;</span><br><span class="line">    <span class="comment">// origin_ip不为空且全部为内网地址则跳过</span></span><br><span class="line">    <span class="keyword">if</span> (origin_ip &amp;&amp; origin_ip.<span class="title function_">every</span>(<span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> internalRegex.<span class="title function_">test</span>(value)</span><br><span class="line">        &#125;))&#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;ip.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (internalRegex.<span class="title function_">test</span>(ip[i]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">action</span>:     algorithmConfig.<span class="property">ssrf_userinput</span>.<span class="property">action</span>,</span><br><span class="line">                <span class="attr">message</span>:    <span class="title function_">_</span>(<span class="string">&quot;SSRF - Requesting intranet address: %1%&quot;</span>, [ ip[i] ]),</span><br><span class="line">                <span class="attr">confidence</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">algorithm</span>:  <span class="string">&#x27;ssrf_userinput&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_internal_hostname</span>(<span class="params">hostname, origin_hostname</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((origin_hostname) &amp;&amp; (origin_hostname == <span class="string">&#x27;[::]&#x27;</span> || origin_hostname == <span class="string">&#x27;[::1]&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hostname == <span class="string">&#x27;[::]&#x27;</span> || hostname == <span class="string">&#x27;[::1]&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">action</span>:     algorithmConfig.<span class="property">ssrf_userinput</span>.<span class="property">action</span>,</span><br><span class="line">            <span class="attr">message</span>:    <span class="title function_">_</span>(<span class="string">&quot;SSRF - Requesting intranet address: %1%&quot;</span>, [ hostname ]),</span><br><span class="line">            <span class="attr">confidence</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">algorithm</span>:  <span class="string">&#x27;ssrf_userinput&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_internal</span>(<span class="params">params, context, is_redirect</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> ret</span><br><span class="line">    <span class="keyword">var</span> all_parameter = <span class="title function_">get_all_parameter</span>(context)</span><br><span class="line">    <span class="keyword">if</span> (is_redirect) &#123;</span><br><span class="line">        ret = <span class="title function_">check_internal_ip</span>(params.<span class="property">ip</span>, params.<span class="property">origin_ip</span>)</span><br><span class="line">        <span class="keyword">if</span> (ret &amp;&amp; !whiteHostName.<span class="title function_">test</span>(params.<span class="property">hostname</span>)) &#123;<span class="keyword">return</span> ret&#125;</span><br><span class="line">        ret = <span class="title function_">check_internal_hostname</span>(params.<span class="property">hostname</span>, params.<span class="property">origin_hostname</span>)</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;<span class="keyword">return</span> ret&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">is_from_userinput</span>(all_parameter, params.<span class="property">url</span>)) &#123;</span><br><span class="line">        <span class="comment">// 非重定向，判定用户输入</span></span><br><span class="line">        ret = <span class="title function_">check_internal_ip</span>(params.<span class="property">ip</span>, <span class="literal">undefined</span>)</span><br><span class="line">        <span class="keyword">if</span> (ret &amp;&amp; !whiteHostName.<span class="title function_">test</span>(params.<span class="property">hostname</span>)) &#123;<span class="keyword">return</span> ret&#125;</span><br><span class="line">        ret = <span class="title function_">check_internal_hostname</span>(params.<span class="property">hostname</span>, <span class="literal">undefined</span>)</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;<span class="keyword">return</span> ret&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_ssrf</span>(<span class="params">params, context, is_redirect</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> hostname  = params.<span class="property">hostname</span></span><br><span class="line">    <span class="keyword">var</span> url       = params.<span class="property">url</span></span><br><span class="line">    <span class="keyword">var</span> ip        = params.<span class="property">ip</span></span><br><span class="line">    <span class="keyword">var</span> reason    = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 算法1 - 当参数来自用户输入，且为内网IP，判定为SSRF攻击</span></span><br><span class="line">    <span class="keyword">if</span> (algorithmConfig.<span class="property">ssrf_userinput</span>.<span class="property">action</span> != <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> ret</span><br><span class="line">        ret = <span class="title function_">check_internal</span>(params, context, is_redirect)</span><br><span class="line">        <span class="comment">// 过滤非HTTP请求（dubbo)</span></span><br><span class="line">        <span class="keyword">var</span> header = context.<span class="property">header</span> || &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (ret &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(header).<span class="property">length</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 算法2 - 检查常见探测域名</span></span><br><span class="line">    <span class="keyword">if</span> (algorithmConfig.<span class="property">ssrf_common</span>.<span class="property">action</span> != <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">is_hostname_dnslog</span>(hostname) || [<span class="string">&#x27;requestb.in&#x27;</span>, <span class="string">&#x27;transfer.sh&#x27;</span>].<span class="title function_">includes</span>(hostname.<span class="title function_">toLowerCase</span>()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">action</span>:     algorithmConfig.<span class="property">ssrf_common</span>.<span class="property">action</span>,</span><br><span class="line">                <span class="attr">message</span>:    <span class="title function_">_</span>(<span class="string">&quot;SSRF - Requesting known DNSLOG address: %1%&quot;</span>, [hostname]),</span><br><span class="line">                <span class="attr">confidence</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">algorithm</span>:  <span class="string">&#x27;ssrf_common&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 算法3 - 检测 AWS/Aliyun/GoogleCloud 私有地址: 拦截IP访问、绑定域名访问两种方式</span></span><br><span class="line">    <span class="keyword">if</span> (algorithmConfig.<span class="property">ssrf_aws</span>.<span class="property">action</span> != <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="string">&#x27;169.254.169.254&#x27;</span> || ip == <span class="string">&#x27;100.100.100.200&#x27;</span> || ip == <span class="string">&#x27;168.63.129.16&#x27;</span></span><br><span class="line">            || hostname == <span class="string">&#x27;169.254.169.254&#x27;</span> || hostname == <span class="string">&#x27;100.100.100.200&#x27;</span> || hostname == <span class="string">&#x27;168.63.129.16&#x27;</span></span><br><span class="line">            || hostname == <span class="string">&#x27;metadata.google.internal&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">action</span>:     algorithmConfig.<span class="property">ssrf_aws</span>.<span class="property">action</span>,</span><br><span class="line">                <span class="attr">message</span>:    <span class="title function_">_</span>(<span class="string">&quot;SSRF - Requesting AWS metadata address&quot;</span>),</span><br><span class="line">                <span class="attr">confidence</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">algorithm</span>:  <span class="string">&#x27;ssrf_aws&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 算法4 - ssrf_obfuscate</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 检查混淆:</span></span><br><span class="line">    <span class="comment">// http://2130706433</span></span><br><span class="line">    <span class="comment">// http://0x7f001</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 以下混淆方式没有检测，容易误报</span></span><br><span class="line">    <span class="comment">// http://0x7f.0x0.0x0.0x1</span></span><br><span class="line">    <span class="comment">// http://0x7f.0.0.0</span></span><br><span class="line">    <span class="keyword">if</span> (algorithmConfig.<span class="property">ssrf_obfuscate</span>.<span class="property">action</span> != <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> reason = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">isNaN</span>(hostname) &amp;&amp; hostname.<span class="property">length</span> != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            reason = <span class="title function_">_</span>(<span class="string">&quot;SSRF - Requesting numeric IP address: %1%&quot;</span>, [hostname])</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// else if (hostname.startsWith(&#x27;0x&#x27;) &amp;&amp; hostname.indexOf(&#x27;.&#x27;) === -1)</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     reason = _(&quot;SSRF - Requesting hexadecimal IP address: %1%&quot;, [hostname])</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reason)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">action</span>:     algorithmConfig.<span class="property">ssrf_obfuscate</span>.<span class="property">action</span>,</span><br><span class="line">                <span class="attr">message</span>:    reason,</span><br><span class="line">                <span class="attr">confidence</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">algorithm</span>:  <span class="string">&#x27;ssrf_obfuscate&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 算法5 - 特殊协议检查</span></span><br><span class="line">    <span class="keyword">if</span> (algorithmConfig.<span class="property">ssrf_protocol</span>.<span class="property">action</span> != <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取协议</span></span><br><span class="line">        <span class="keyword">var</span> proto = url.<span class="title function_">split</span>(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>].<span class="title function_">toLowerCase</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (algorithmConfig.<span class="property">ssrf_protocol</span>.<span class="property">protocols</span>.<span class="title function_">indexOf</span>(proto) != -<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">action</span>:     algorithmConfig.<span class="property">ssrf_protocol</span>.<span class="property">action</span>,</span><br><span class="line">                <span class="attr">message</span>:    <span class="title function_">_</span>(<span class="string">&quot;SSRF - Using dangerous protocol: %1%://&quot;</span>, [proto]),</span><br><span class="line">                <span class="attr">confidence</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">algorithm</span>:  <span class="string">&#x27;ssrf_protocol&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.正则表达式</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 匹配内网地址</span></span><br><span class="line"><span class="keyword">var</span> internalRegex   = <span class="regexp">/^(0\.0\.0|127|10|192\.168|172\.(1[6-9]|2[0-9]|3[01]))\./</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ssrf白名单主机名</span></span><br><span class="line"><span class="keyword">var</span> whiteHostName   = <span class="regexp">/\.bcebos\.com$|(^|\.)oss-[\d\w\-]&#123;0,30&#125;\.aliyuncs\.com$/</span></span><br></pre></td></tr></table></figure>

<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>《Java代码审计-入门篇》和《Java代码审计实战》</span><br><span class="line"><span class="number">2.</span>官方文档 Hook函数列表 和 功能说明</span><br><span class="line">	https:<span class="comment">//rasp.baidu.com/doc/hacking/architect/hook.html</span></span><br><span class="line">	https:<span class="comment">//rasp.baidu.com/doc/usage/main.html</span></span><br><span class="line"><span class="number">3.</span>一个支持<span class="number">302</span>跳转的py脚本</span><br><span class="line">	https:<span class="comment">//www.cnblogs.com/zpchcbd/p/14993777.html</span></span><br><span class="line"><span class="number">4.</span>Java Sec Code靶场</span><br><span class="line">	https:<span class="comment">//github.com/JoyChou93/java-sec-code</span></span><br><span class="line"><span class="number">5.</span>SSRF in Java</span><br><span class="line">	https:<span class="comment">//xz.aliyun.com/t/206</span></span><br><span class="line"><span class="number">6.</span>gopher 协议在SSRF中的一些利用</span><br><span class="line">	https:<span class="comment">//xz.aliyun.com/t/6993</span></span><br><span class="line"><span class="number">7.</span>Just Gopher It：以 <span class="number">1.5</span> 万美元的价格将盲目SSRF升级为 RCE — Yahoo Mail</span><br><span class="line">	https:<span class="comment">//sirleeroyjenkins.medium.com/just-gopher-it-escalating-a-blind-ssrf-to-rce-for-15k-f5329a974530</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://bmsk1994.github.io">bmsk</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://bmsk1994.github.io/2022/12/22/OpenRASP-SSRF%E6%BC%8F%E6%B4%9E/">https://bmsk1994.github.io/2022/12/22/OpenRASP-SSRF漏洞/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OpenRASP/">OpenRASP</a></div><div class="post_share"><div class="social-share" data-image="/img/ssrf.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/27/OpenRASP-XXE%E6%BC%8F%E6%B4%9E/"><img class="prev-cover" src="/img/xxe.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">OpenRASP-XXE漏洞</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/08/OpenRASP%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E/"><img class="next-cover" src="/img/fileoperate.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">OpenRASP文件操作漏洞</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/11/18/Java-Agent/" title="Java Agent"><img class="cover" src="/img/Java%20agent.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-18</div><div class="title">Java Agent</div></div></a></div><div><a href="/2022/12/27/OpenRASP-XXE%E6%BC%8F%E6%B4%9E/" title="OpenRASP-XXE漏洞"><img class="cover" src="/img/xxe.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">OpenRASP-XXE漏洞</div></div></a></div><div><a href="/2022/11/25/OpenRASP%E4%B8%BB%E7%BA%BF%E9%80%BB%E8%BE%91/" title="OpenRASP主线逻辑"><img class="cover" src="/img/mainline.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-25</div><div class="title">OpenRASP主线逻辑</div></div></a></div><div><a href="/2022/12/07/OpenRASP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" title="OpenRASP-文件上传漏洞"><img class="cover" src="/img/fileupload.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-07</div><div class="title">OpenRASP-文件上传漏洞</div></div></a></div><div><a href="/2022/12/08/OpenRASP%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E/" title="OpenRASP文件操作漏洞"><img class="cover" src="/img/fileoperate.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-08</div><div class="title">OpenRASP文件操作漏洞</div></div></a></div><div><a href="/2022/11/25/OpenRASP%E7%B1%BB%E5%8A%A0%E8%BD%BD/" title="OpenRASP类加载"><img class="cover" src="/img/classloader.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-25</div><div class="title">OpenRASP类加载</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">bmsk</div><div class="author-info__description">锦衣疾马，自此西行</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/BMSK1994"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/BMSK1994" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1679897187@qq.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenRASP-SSRF%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">OpenRASP-SSRF漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.</span> <span class="toc-text">业务代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-URLConnection%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.URLConnection实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-HttpClient%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.HttpClient实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenRASP%E6%A3%80%E6%B5%8B%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text">OpenRASP检测流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpClientHook"><span class="toc-number">1.4.1.</span> <span class="toc-text">HttpClientHook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URLConnectionHook"><span class="toc-number">1.4.2.</span> <span class="toc-text">URLConnectionHook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpClientRedirectHook%EF%BC%88302%E9%87%8D%E5%AE%9A%E5%90%91SSRF%EF%BC%89"><span class="toc-number">1.4.3.</span> <span class="toc-text">HttpClientRedirectHook（302重定向SSRF）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#302%E9%87%8D%E5%AE%9A%E5%90%91SSRF"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">302重定向SSRF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenRASP%E6%A3%80%E6%B5%8B%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">OpenRASP检测重定向</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URLConnectionRedirectHook%EF%BC%88302%E9%87%8D%E5%AE%9A%E5%90%91SSRF%EF%BC%89"><span class="toc-number">1.4.4.</span> <span class="toc-text">URLConnectionRedirectHook（302重定向SSRF）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JVM%E4%B8%AD%E5%8E%9F%E8%AF%AD%E7%B1%BB%E5%9E%8B%E7%AD%BE%E5%90%8D"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">JVM中原语类型签名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E4%B8%ADSSRF%E7%9A%84%E9%99%90%E5%88%B6"><span class="toc-number">1.5.</span> <span class="toc-text">Java中SSRF的限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSRF%E6%A3%80%E6%B5%8B%E7%AE%97%E6%B3%95"><span class="toc-number">1.6.</span> <span class="toc-text">SSRF检测算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.7.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/12/27/OpenRASP-XXE%E6%BC%8F%E6%B4%9E/" title="OpenRASP-XXE漏洞"><img src="/img/xxe.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenRASP-XXE漏洞"/></a><div class="content"><a class="title" href="/2022/12/27/OpenRASP-XXE%E6%BC%8F%E6%B4%9E/" title="OpenRASP-XXE漏洞">OpenRASP-XXE漏洞</a><time datetime="2022-12-27T05:12:53.000Z" title="Created 2022-12-27 13:12:53">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/22/OpenRASP-SSRF%E6%BC%8F%E6%B4%9E/" title="OpenRASP-SSRF漏洞"><img src="/img/ssrf.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenRASP-SSRF漏洞"/></a><div class="content"><a class="title" href="/2022/12/22/OpenRASP-SSRF%E6%BC%8F%E6%B4%9E/" title="OpenRASP-SSRF漏洞">OpenRASP-SSRF漏洞</a><time datetime="2022-12-22T15:40:35.000Z" title="Created 2022-12-22 23:40:35">2022-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/08/OpenRASP%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E/" title="OpenRASP文件操作漏洞"><img src="/img/fileoperate.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenRASP文件操作漏洞"/></a><div class="content"><a class="title" href="/2022/12/08/OpenRASP%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E/" title="OpenRASP文件操作漏洞">OpenRASP文件操作漏洞</a><time datetime="2022-12-08T13:46:09.000Z" title="Created 2022-12-08 21:46:09">2022-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/07/OpenRASP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" title="OpenRASP-文件上传漏洞"><img src="/img/fileupload.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenRASP-文件上传漏洞"/></a><div class="content"><a class="title" href="/2022/12/07/OpenRASP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" title="OpenRASP-文件上传漏洞">OpenRASP-文件上传漏洞</a><time datetime="2022-12-07T12:49:25.000Z" title="Created 2022-12-07 20:49:25">2022-12-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/25/OpenRASP%E7%B1%BB%E5%8A%A0%E8%BD%BD/" title="OpenRASP类加载"><img src="/img/classloader.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenRASP类加载"/></a><div class="content"><a class="title" href="/2022/11/25/OpenRASP%E7%B1%BB%E5%8A%A0%E8%BD%BD/" title="OpenRASP类加载">OpenRASP类加载</a><time datetime="2022-11-25T12:09:33.000Z" title="Created 2022-11-25 20:09:33">2022-11-25</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/ssrf.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By bmsk</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>